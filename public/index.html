<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MY1 Smart Trading Platform</title>
  <style>
    :root {
      color-scheme: light;
      --bg: radial-gradient(circle at 10% 20%, #0f172a, #1d4ed8 55%, #2563eb 100%);
      --surface: rgba(255, 255, 255, 0.92);
      --surface-strong: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-dark: #1e40af;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --success: #16a34a;
      --danger: #dc2626;
      --shadow: 0 32px 60px rgba(15, 23, 42, 0.28);
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", "Cairo", "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    a { color: inherit; text-decoration: none; }

    .site {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .site-header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.65);
      color: #fff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .site-header .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px clamp(20px, 6vw, 48px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 46px;
      height: 46px;
      border-radius: 16px;
      background: rgba(255,255,255,0.12);
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
    }

    .tagline {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tagline strong {
      font-size: 1rem;
    }

    .tagline span {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .language-toggle {
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 999px;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .language-toggle:hover { background: rgba(255,255,255,0.18); }

    .ghost-link {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      transition: background 0.2s ease;
    }

    .ghost-link:hover { background: rgba(255,255,255,0.2); }

    .hero {
      padding: clamp(48px, 8vw, 100px) clamp(20px, 10vw, 140px);
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.45), transparent 52%),
                  radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.42), transparent 55%);
      pointer-events: none;
    }

    .hero-content {
      position: relative;
      z-index: 1;
      display: grid;
      gap: clamp(32px, 5vw, 70px);
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      align-items: center;
    }

    .hero h1 {
      font-size: clamp(2.4rem, 5.6vw, 3.8rem);
      margin: 0 0 18px;
      line-height: 1.05;
    }

    .hero p {
      margin: 0;
      font-size: clamp(1rem, 2.4vw, 1.2rem);
      color: rgba(255,255,255,0.88);
      max-width: 540px;
    }

    .hero-actions {
      margin-top: 28px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 22px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn.primary {
      background: #fff;
      color: var(--accent);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.35);
    }

    .btn.primary:hover { transform: translateY(-2px); }

    .btn.secondary {
      background: rgba(255,255,255,0.14);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.25);
    }

    .btn.secondary:hover { background: rgba(255,255,255,0.25); }

    .btn-text {
      border: none;
      background: transparent;
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      padding: 0;
      font-size: 0.9rem;
    }

    .btn-text.danger { color: var(--danger); }

    .features {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .feature-card {
      background: rgba(15, 23, 42, 0.55);
      color: #fff;
      padding: 20px 22px;
      border-radius: 20px;
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.35);
    }

    .feature-card h3 { margin: 0 0 12px; font-size: 1.15rem; }
    .feature-card p { margin: 0; font-size: 0.95rem; color: rgba(255,255,255,0.82); }

    .auth-section {
      margin-top: -90px;
      padding: 0 clamp(20px, 7vw, 140px) clamp(80px, 9vw, 140px);
      display: flex;
      justify-content: center;
    }

    .auth-card {
      background: var(--surface);
      border-radius: 26px;
      box-shadow: var(--shadow);
      max-width: 1000px;
      width: 100%;
      padding: clamp(26px, 4vw, 52px);
      display: grid;
      gap: 26px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .auth-copy h2 { margin: 0 0 16px; font-size: 1.7rem; }
    .auth-copy p { margin: 0; color: var(--muted); line-height: 1.6; }

    .auth-panel {
      background: var(--surface-strong);
      border-radius: 22px;
      padding: 24px 26px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .auth-tabs {
      display: inline-flex;
      background: rgba(15, 23, 42, 0.05);
      border-radius: 14px;
      padding: 4px;
      margin-bottom: 12px;
    }

    .auth-tabs button {
      border: none;
      background: transparent;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .auth-tabs button.is-active {
      background: var(--surface);
      color: var(--accent);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.18);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      display: block;
    }

    input, textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(241, 245, 249, 0.7);
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      background: #fff;
    }

    .muted { color: var(--muted); }
    .small { font-size: 0.85rem; }

    .rule-alert {
      margin-top: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--danger);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .rule-alert::before {
      content: "⚠";
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-inline-end: 2px;
    }

    .hidden { display: none !important; }

    /* Dashboard */
    #dashboard {
      padding: clamp(40px, 6vw, 72px) clamp(20px, 8vw, 120px);
      background: #f5f6fb;
      min-height: 100vh;
    }

    .dashboard-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      margin-bottom: 28px;
    }

    .dashboard-header h1 {
      margin: 0 0 8px;
      font-size: clamp(1.8rem, 4vw, 2.4rem);
    }

    .user-meta {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.85rem;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
    }

    .pill.success { background: rgba(22, 163, 74, 0.16); color: var(--success); }
    .pill.danger { background: rgba(220, 38, 38, 0.12); color: var(--danger); }

    .dashboard-grid {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      margin-bottom: 32px;
    }

    .card {
      background: #fff;
      border-radius: 22px;
      padding: 26px;
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .card h2 { margin: 0 0 12px; font-size: 1.2rem; }
    .card p { margin: 0 0 12px; color: var(--muted); }

    .status {
      min-height: 24px;
      margin-bottom: 20px;
      font-weight: 600;
      transition: opacity 0.25s ease;
    }

    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }
    .status.info { color: var(--accent); }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .btn.ghost {
      background: rgba(15, 23, 42, 0.05);
      color: var(--text);
    }

    .btn.danger {
      background: rgba(220, 38, 38, 0.12);
      color: var(--danger);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    .btn[data-loading="true"]::after {
      content: "";
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.45);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }

    .btn.primary[data-loading="true"]::after {
      border-color: rgba(37, 99, 235, 0.35);
      border-top-color: var(--accent);
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: rgba(15, 23, 42, 0.25);
      transition: background 0.2s ease;
      border-radius: 999px;
    }

    .slider::before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      transition: transform 0.2s ease;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
    }

    .switch input:checked + .slider {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .switch input:checked + .slider::before {
      transform: translateX(20px);
    }

    .table-card { margin-bottom: 28px; }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .table-wrapper { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 680px;
    }

    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      text-align: left;
      font-size: 0.92rem;
    }

    thead th {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.03);
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr.is-paused { opacity: 0.65; }

    .symbol { font-weight: 700; letter-spacing: 0.02em; font-size: 1rem; }
    details.ai-details summary {
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--accent);
    }

    details.ai-details {
      margin-top: 6px;
    }

    .ai-summary {
      background: rgba(15, 23, 42, 0.04);
      padding: 10px 12px;
      border-radius: 10px;
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text);
      white-space: pre-wrap;
    }

    tr.empty-row td {
      text-align: center;
      padding: 36px 16px;
      color: var(--muted);
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .site-header .container { flex-direction: column; align-items: stretch; }
      .brand { justify-content: space-between; }
      .header-actions { justify-content: space-between; }
      .auth-card { padding: 24px; }
      table { min-width: 100%; }
      thead { display: none; }
      tbody tr { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px 0; }
      tbody td { border-bottom: none; padding: 0; font-size: 0.9rem; }
      tbody td::before {
        content: attr(data-label);
        display: block;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 4px;
      }
    }
  </style>
</head>
<body>
  <div class="site">
    <header class="site-header">
      <div class="container">
        <div class="brand">
          <span class="logo">MY1</span>
          <div class="tagline">
            <strong data-i18n="header.taglineTitle">Smart crypto autopilot</strong>
            <span data-i18n="header.taglineSubtitle">Designed for modern spot traders.</span>
          </div>
        </div>
        <div class="header-actions">
          <button id="languageToggle" class="language-toggle" type="button">عربي</button>
          <a class="ghost-link" data-scroll-to-auth href="#authSection" data-i18n="header.cta">Explore dashboard</a>
        </div>
      </div>
    </header>

    <section class="hero" id="landing">
      <div class="hero-content">
        <div>
          <h1 data-i18n="hero.title">Trade smarter with AI-assisted automation</h1>
          <p data-i18n="hero.subtitle">MY1 monitors the market in real time, suggests AI-powered strategies, and executes your spot rules with transparent controls.</p>
          <div class="hero-actions">
            <button class="btn primary" data-scroll-to-auth type="button" data-i18n="hero.primaryCta">Start now</button>
            <button class="btn secondary" type="button" data-scroll-to-auth data-i18n="hero.secondaryCta">See how it works</button>
          </div>
        </div>
        <div class="features">
          <article class="feature-card">
            <h3 data-i18n="features.automationTitle">Personal rule engine</h3>
            <p data-i18n="features.automationCopy">Define dip buying and take-profit logic with full transparency. Rules stay under your account control.</p>
          </article>
          <article class="feature-card">
            <h3 data-i18n="features.securityTitle">Secure key management</h3>
            <p data-i18n="features.securityCopy">Connect Binance spot keys with encryption. You are always able to rotate or disconnect in one click.</p>
          </article>
          <article class="feature-card">
            <h3 data-i18n="features.aiTitle">AI market insights</h3>
            <p data-i18n="features.aiCopy">Leverage live market research prompts to craft strategies backed by up-to-date data.</p>
          </article>
        </div>
      </div>
    </section>

    <section class="auth-section" id="authSection">
      <div class="auth-card">
        <div class="auth-copy">
          <h2 data-i18n="auth.title">Your personal trading cockpit</h2>
          <p data-i18n="auth.description">Track AI-generated ideas, manage manual rules, and sync Binance activity from a single secure interface.</p>
        </div>
        <div class="auth-panel">
          <div class="auth-tabs">
            <button type="button" class="is-active" data-auth-tab="login" data-i18n="auth.loginTab">Sign in</button>
            <button type="button" data-auth-tab="register" data-i18n="auth.registerTab">Create account</button>
          </div>
          <form id="loginForm" data-auth-panel="login">
            <div>
              <label for="loginEmail" data-i18n="auth.emailLabel">Email</label>
              <input id="loginEmail" type="email" autocomplete="email" required data-i18n-placeholder="auth.emailPlaceholder">
            </div>
            <div>
              <label for="loginPassword" data-i18n="auth.passwordLabel">Password</label>
              <input id="loginPassword" type="password" autocomplete="current-password" required data-i18n-placeholder="auth.passwordPlaceholder">
            </div>
            <button class="btn primary" type="submit" data-i18n="auth.loginCta">Sign in</button>
          </form>
          <form id="registerForm" data-auth-panel="register" class="hidden">
            <div>
              <label for="registerName" data-i18n="auth.nameLabel">Full name</label>
              <input id="registerName" required data-i18n-placeholder="auth.namePlaceholder">
            </div>
            <div>
              <label for="registerEmail" data-i18n="auth.emailLabel">Email</label>
              <input id="registerEmail" type="email" autocomplete="email" required data-i18n-placeholder="auth.emailPlaceholder">
            </div>
            <div>
              <label for="registerPassword" data-i18n="auth.passwordLabel">Password</label>
              <input id="registerPassword" type="password" autocomplete="new-password" required data-i18n-placeholder="auth.passwordPlaceholder">
            </div>
            <button class="btn primary" type="submit" data-i18n="auth.registerCta">Create account</button>
          </form>
        </div>
      </div>
    </section>

    <main id="dashboard" class="hidden">
      <div class="dashboard-header">
        <div>
          <h1 data-i18n="dashboard.title">MY1 control center</h1>
          <p class="muted" data-i18n="dashboard.subtitle">Manage AI ideas, monitor open orders, and keep your Binance link under supervision.</p>
        </div>
        <div class="user-meta">
          <span class="pill" id="welcomeName" data-i18n="dashboard.welcome">Welcome</span>
          <button class="btn ghost" id="logoutBtn" type="button" data-i18n="dashboard.logout">Sign out</button>
        </div>
      </div>

      <div id="status" class="status" role="status" aria-live="polite"></div>

      <section class="dashboard-grid">
        <article class="card">
          <h2 data-i18n="api.title">Connect Binance keys</h2>
          <p data-i18n="api.description">Add your spot API credentials to activate the engine. Keys remain encrypted and you can revoke them any time.</p>
          <div>
            <span data-i18n="api.statusLabel">Status:</span> <span id="apiKeysStatus" class="pill danger" data-i18n="api.disconnected">Disconnected</span>
          </div>
          <form id="apiKeysForm">
            <div>
              <label for="apiKey" data-i18n="api.keyLabel">API key</label>
              <input id="apiKey" autocomplete="off" required placeholder="XXXXXXXX">
            </div>
            <div>
              <label for="apiSecret" data-i18n="api.secretLabel">API secret</label>
              <input id="apiSecret" autocomplete="off" required placeholder="XXXXXXXX">
            </div>
            <div class="actions">
              <button class="btn primary" type="submit" data-i18n="api.save">Save keys</button>
              <button class="btn ghost" type="button" id="removeKeys" data-i18n="api.remove">Disconnect</button>
            </div>
            <p class="muted small" data-i18n="api.helper">Use spot trading keys with read and trade permissions only.</p>
          </form>
        </article>

        <article class="card">
          <h2 data-i18n="manual.title">Manual rule</h2>
          <p data-i18n="manual.description">Create a dip buying strategy with your preferred take-profit target.</p>
          <form id="manualForm">
            <div class="form-row">
              <div>
                <label for="symbol" data-i18n="manual.symbolLabel">Pair</label>
                <input id="symbol" required data-i18n-placeholder="manual.symbolPlaceholder">
              </div>
              <div>
                <label for="dip" data-i18n="manual.dipLabel">Buy the dip %</label>
                <input id="dip" type="number" step="0.01" min="0" required data-i18n-placeholder="manual.dipPlaceholder">
              </div>
            </div>
            <div class="form-row">
              <div>
                <label for="tp" data-i18n="manual.tpLabel">Take profit %</label>
                <input id="tp" type="number" step="0.01" min="0" required data-i18n-placeholder="manual.tpPlaceholder">
              </div>
              <div>
                <label for="budget" data-i18n="manual.budgetLabel">Trade budget (USDT)</label>
                <input id="budget" type="number" step="0.01" min="0" required data-i18n-placeholder="manual.budgetPlaceholder">
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" type="submit" data-i18n="manual.add">Add rule</button>
              <button class="btn ghost" type="button" id="syncRules" data-i18n="manual.sync">Sync with engine</button>
            </div>
          </form>
        </article>

        <article class="card">
          <h2 data-i18n="ai.title">AI-powered rule</h2>
          <p data-i18n="ai.description">Request a market-ready spot strategy backed by real-time research.</p>
          <form id="aiForm">
            <div>
              <label for="aiBudget" data-i18n="ai.budgetLabel">AI budget (USDT)</label>
              <input id="aiBudget" type="number" min="10" value="100" required>
            </div>
            <div>
              <label for="aiModel" data-i18n="ai.modelLabel">Model</label>
              <input id="aiModel" value="gpt-4o-mini" disabled>
            </div>
            <button class="btn primary" id="aiGenerate" type="submit" data-i18n="ai.generate">Generate with AI</button>
            <p class="muted small" data-i18n="ai.helper">The assistant researches live data before returning a ready-to-use rule.</p>
          </form>
        </article>
      </section>
      <section class="card table-card">
        <div class="table-header">
          <h2 data-i18n="manual.tableTitle">Manual rules</h2>
          <span class="pill" id="manualCount">0</span>
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="manualRulesTable">
            <thead>
              <tr>
                <th data-i18n="manual.table.rule">Rule</th>
                <th data-i18n="manual.table.targets">Targets</th>
                <th data-i18n="manual.table.budget">Budget</th>
                <th data-i18n="manual.table.status">Status</th>
                <th data-i18n="manual.table.actions">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card table-card">
        <div class="table-header">
          <h2 data-i18n="ai.tableTitle">AI rules</h2>
          <span class="pill" id="aiCount">0</span>
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="aiRulesTable">
            <thead>
              <tr>
                <th data-i18n="ai.table.rule">Rule</th>
                <th data-i18n="ai.table.entry">Entry price</th>
                <th data-i18n="ai.table.exit">Take-profit</th>
                <th data-i18n="ai.table.budget">Budget</th>
                <th data-i18n="ai.table.status">Status</th>
                <th data-i18n="ai.table.actions">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card table-card">
        <div class="table-header">
          <h2 data-i18n="orders.title">Open orders</h2>
          <div class="actions">
            <button class="btn ghost" id="refreshOrders" type="button" data-i18n="orders.refresh">Refresh</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="ordersTable">
            <thead>
              <tr>
                <th data-i18n="orders.table.symbol">Pair</th>
                <th data-i18n="orders.table.side">Side</th>
                <th data-i18n="orders.table.price">Price</th>
                <th data-i18n="orders.table.qty">Quantity</th>
                <th data-i18n="orders.table.type">Type</th>
                <th data-i18n="orders.table.status">Status</th>
                <th data-i18n="orders.table.updated">Last update</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
  (function(){
    const translations = {
      en: {
        meta: { title: "MY1 Smart Trading Platform" },
        header: {
          taglineTitle: "Smart crypto autopilot",
          taglineSubtitle: "Designed for modern spot traders.",
          cta: "Explore dashboard"
        },
        hero: {
          title: "Trade smarter with AI-assisted automation",
          subtitle: "MY1 monitors the market in real time, suggests AI-powered strategies, and executes your spot rules with transparent controls.",
          primaryCta: "Start now",
          secondaryCta: "See how it works"
        },
        features: {
          automationTitle: "Personal rule engine",
          automationCopy: "Define dip buying and take-profit logic with full transparency. Rules stay under your account control.",
          securityTitle: "Secure key management",
          securityCopy: "Connect Binance spot keys with encryption. You are always able to rotate or disconnect in one click.",
          aiTitle: "AI market insights",
          aiCopy: "Leverage live market research prompts to craft strategies backed by up-to-date data."
        },
        auth: {
          title: "Your personal trading cockpit",
          description: "Track AI-generated ideas, manage manual rules, and sync Binance activity from a single secure interface.",
          loginTab: "Sign in",
          registerTab: "Create account",
          emailLabel: "Email",
          emailPlaceholder: "name@example.com",
          passwordLabel: "Password",
          passwordPlaceholder: "Enter password",
          nameLabel: "Full name",
          namePlaceholder: "How should we greet you?",
          loginCta: "Sign in",
          registerCta: "Create account"
        },
        dashboard: {
          title: "MY1 control center",
          subtitle: "Manage AI ideas, monitor open orders, and keep your Binance link under supervision.",
          welcome: "Welcome",
          logout: "Sign out"
        },
        api: {
          title: "Connect Binance keys",
          description: "Add your spot API credentials to activate the engine. Keys remain encrypted and you can revoke them any time.",
          statusLabel: "Status:",
          connected: "Connected",
          disconnected: "Disconnected",
          keyLabel: "API key",
          secretLabel: "API secret",
          save: "Save keys",
          remove: "Disconnect",
          helper: "Use spot trading keys with read and trade permissions only."
        },
        manual: {
          title: "Manual rule",
          description: "Create a dip buying strategy with your preferred take-profit target.",
          symbolLabel: "Pair",
          symbolPlaceholder: "Example: SOLUSDT",
          dipLabel: "Buy the dip %",
          dipPlaceholder: "2",
          tpLabel: "Take profit %",
          tpPlaceholder: "2",
          budgetLabel: "Trade budget (USDT)",
          budgetPlaceholder: "50",
          add: "Add rule",
          sync: "Sync with engine",
          tableTitle: "Manual rules",
          table: {
            rule: "Rule",
            targets: "Targets",
            budget: "Budget",
            status: "Status",
            actions: "Actions"
          }
        },
        ai: {
          title: "AI-powered rule",
          description: "Request a market-ready spot strategy backed by real-time research.",
          budgetLabel: "AI budget (USDT)",
          modelLabel: "Model",
          generate: "Generate with AI",
          helper: "The assistant researches live data before returning a ready-to-use rule.",
          tableTitle: "AI rules",
          table: {
            rule: "Rule",
            entry: "Entry price",
            exit: "Take-profit",
            budget: "Budget",
            status: "Status",
            actions: "Actions"
          }
        },
        orders: {
          title: "Open orders",
          refresh: "Refresh",
          table: {
            symbol: "Pair",
            side: "Side",
            price: "Price",
            qty: "Quantity",
            type: "Type",
            status: "Status",
            updated: "Last update"
          },
          empty: "No open orders right now."
        },
        manualRules: {
          buyOnDipLabel: "Buy on dip:",
          takeProfitLabel: "Take profit:",
          empty: "No manual rules yet."
        },
        aiRules: {
          summaryToggle: "View AI summary",
          empty: "No AI rules yet."
        },
        common: {
          delete: "Delete",
          confirmDelete: "Delete this rule?",
          enabled: "Enabled",
          disabled: "Disabled"
        },
        status: {
          loginSuccess: "Signed in successfully.",
          registerSuccess: "Account created successfully.",
          keysSaved: "API keys saved.",
          keysRemoved: "Connection removed.",
          manualAdded: "Manual rule added.",
          manualSynced: "Rules synced with engine.",
          aiGenerated: "AI rule generated successfully.",
          ordersRefreshed: "Open orders refreshed.",
          ruleActivated: "Rule enabled.",
          rulePaused: "Rule paused.",
          ruleDeleted: "Rule deleted.",
          aiBudgetInvalid: "Enter a valid AI budget.",
          ruleError: "Engine notice: {{message}}"
        }
      },
      ar: {
        meta: { title: "منصة MY1 للتداول الذكي" },
        header: {
          taglineTitle: "طيار آلي ذكي للعملات الرقمية",
          taglineSubtitle: "مصمم لمتداولي السبوت العصريين.",
          cta: "استكشف اللوحة"
        },
        hero: {
          title: "تداول بذكاء مع أتمتة مدعومة بالذكاء الاصطناعي",
          subtitle: "تراقب MY1 السوق لحظيًا، وتقترح استراتيجيات مدعومة بالذكاء الاصطناعي، وتنفذ قواعدك بوضوح كامل.",
          primaryCta: "ابدأ الآن",
          secondaryCta: "تعرّف على آلية العمل"
        },
        features: {
          automationTitle: "محرك قواعد شخصي",
          automationCopy: "كوِّن قواعد شراء عند الانخفاض وجني ربح مع تحكم كامل. تبقى القواعد تحت إدارة حسابك دائمًا.",
          securityTitle: "إدارة مفاتيح آمنة",
          securityCopy: "اربط مفاتيح Binance Spot بتشفير كامل مع إمكانية الفصل أو التدوير بضغطة زر.",
          aiTitle: "رؤى سوقية بالذكاء الاصطناعي",
          aiCopy: "استفد من برومبتات بحث مباشرة لصياغة استراتيجيات مبنية على بيانات محدثة."
        },
        auth: {
          title: "قمرة القيادة الخاصة بك",
          description: "تابع أفكار الذكاء الاصطناعي، أدر القواعد اليدوية، وراقب نشاط Binance من واجهة آمنة واحدة.",
          loginTab: "تسجيل الدخول",
          registerTab: "إنشاء حساب",
          emailLabel: "البريد الإلكتروني",
          emailPlaceholder: "name@example.com",
          passwordLabel: "كلمة المرور",
          passwordPlaceholder: "أدخل كلمة المرور",
          nameLabel: "الاسم الكامل",
          namePlaceholder: "كيف نرحب بك؟",
          loginCta: "دخول",
          registerCta: "إنشاء حساب"
        },
        dashboard: {
          title: "مركز تحكم MY1",
          subtitle: "أدر أفكار الذكاء الاصطناعي، راقب الأوامر المفتوحة، وأشرف على ربط Binance.",
          welcome: "مرحبًا",
          logout: "تسجيل الخروج"
        },
        api: {
          title: "ربط مفاتيح Binance",
          description: "أضف مفاتيح السبوت الخاصة بك لتفعيل المحرك. تبقى المفاتيح مشفرة ويمكنك إزالتها في أي وقت.",
          statusLabel: "الحالة:",
          connected: "متصل",
          disconnected: "غير متصل",
          keyLabel: "مفتاح API",
          secretLabel: "سر API",
          save: "حفظ المفاتيح",
          remove: "إلغاء الربط",
          helper: "استخدم مفاتيح تداول Spot بصلاحيات القراءة والتداول فقط."
        },
        manual: {
          title: "قاعدة يدوية",
          description: "اصنع إستراتيجية شراء عند الانخفاض بأهداف جني ربح مخصصة.",
          symbolLabel: "الزوج",
          symbolPlaceholder: "مثال: SOLUSDT",
          dipLabel: "نسبة الشراء عند الانخفاض %",
          dipPlaceholder: "2",
          tpLabel: "نسبة جني الربح %",
          tpPlaceholder: "2",
          budgetLabel: "ميزانية الصفقة (USDT)",
          budgetPlaceholder: "50",
          add: "إضافة القاعدة",
          sync: "مزامنة مع المحرك",
          tableTitle: "القواعد اليدوية",
          table: {
            rule: "القاعدة",
            targets: "الأهداف",
            budget: "الميزانية",
            status: "الحالة",
            actions: "إجراءات"
          }
        },
        ai: {
          title: "قاعدة بالذكاء الاصطناعي",
          description: "اطلب إستراتيجية تداول فورية مدعومة ببحث لحظي.",
          budgetLabel: "ميزانية الذكاء الاصطناعي (USDT)",
          modelLabel: "النموذج",
          generate: "توليد بالذكاء الاصطناعي",
          helper: "يقوم المساعد بالبحث في البيانات المباشرة قبل إرسال القاعدة.",
          tableTitle: "قواعد الذكاء الاصطناعي",
          table: {
            rule: "القاعدة",
            entry: "سعر الدخول",
            exit: "هدف الربح",
            budget: "الميزانية",
            status: "الحالة",
            actions: "إجراءات"
          }
        },
        orders: {
          title: "الأوامر المفتوحة",
          refresh: "تحديث",
          table: {
            symbol: "الزوج",
            side: "الاتجاه",
            price: "السعر",
            qty: "الكمية",
            type: "النوع",
            status: "الحالة",
            updated: "آخر تحديث"
          },
          empty: "لا توجد أوامر مفتوحة حاليًا."
        },
        manualRules: {
          buyOnDipLabel: "الشراء عند الانخفاض:",
          takeProfitLabel: "جني الربح:",
          empty: "لا توجد قواعد يدوية بعد."
        },
        aiRules: {
          summaryToggle: "عرض ملخص الذكاء الاصطناعي",
          empty: "لا توجد قواعد ذكاء اصطناعي بعد."
        },
        common: {
          delete: "حذف",
          confirmDelete: "حذف هذه القاعدة؟",
          enabled: "مفعل",
          disabled: "موقوف"
        },
        status: {
          loginSuccess: "تم تسجيل الدخول بنجاح.",
          registerSuccess: "تم إنشاء الحساب بنجاح.",
          keysSaved: "تم حفظ مفاتيح API.",
          keysRemoved: "تم إلغاء الربط.",
          manualAdded: "تمت إضافة القاعدة اليدوية.",
          manualSynced: "تمت مزامنة القواعد مع المحرك.",
          aiGenerated: "تم توليد قاعدة ذكاء اصطناعي بنجاح.",
          ordersRefreshed: "تم تحديث الأوامر المفتوحة.",
          ruleActivated: "تم تفعيل القاعدة.",
          rulePaused: "تم إيقاف القاعدة.",
          ruleDeleted: "تم حذف القاعدة.",
          aiBudgetInvalid: "أدخل ميزانية صحيحة للذكاء الاصطناعي.",
          ruleError: "تنبيه المحرك: {{message}}"
        }
      }
    };

    const state = {
      language: localStorage.getItem('mybot_language') || 'en',
      token: localStorage.getItem('mybot_token') || '',
      user: null,
      rules: [],
      ordersTimer: null,
      statusTimer: null,
      hasKeys: false,
      isOrdersLoading: false
    };

    const generateId = () => {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return `rule_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    };

    const landing = document.getElementById('landing');
    const authSection = document.getElementById('authSection');
    const dashboard = document.getElementById('dashboard');
    const statusEl = document.getElementById('status');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const authTabs = document.querySelectorAll('[data-auth-tab]');
    const welcomeName = document.getElementById('welcomeName');
    const logoutBtn = document.getElementById('logoutBtn');
    const apiKeysStatus = document.getElementById('apiKeysStatus');
    const apiKeysForm = document.getElementById('apiKeysForm');
    const removeKeysBtn = document.getElementById('removeKeys');
    const manualForm = document.getElementById('manualForm');
    const syncRulesBtn = document.getElementById('syncRules');
    const aiForm = document.getElementById('aiForm');
    const aiGenerateBtn = document.getElementById('aiGenerate');
    const manualTableBody = document.querySelector('#manualRulesTable tbody');
    const aiTableBody = document.querySelector('#aiRulesTable tbody');
    const ordersTableBody = document.querySelector('#ordersTable tbody');
    const manualCountEl = document.getElementById('manualCount');
    const aiCountEl = document.getElementById('aiCount');
    const refreshOrdersBtn = document.getElementById('refreshOrders');
    const languageToggle = document.getElementById('languageToggle');

    function resolveTranslation(lang, key) {
      const fallback = translations.en;
      const parts = key.split('.');
      let target = translations[lang] || translations.en;
      let fallbackTarget = fallback;
      for (const part of parts) {
        target = target && target[part] !== undefined ? target[part] : undefined;
        fallbackTarget = fallbackTarget && fallbackTarget[part] !== undefined ? fallbackTarget[part] : undefined;
      }
      return target !== undefined ? target : fallbackTarget;
    }

    function translate(key, params) {
      let value = resolveTranslation(state.language, key);
      if (typeof value !== 'string') return key;
      if (params) {
        value = value.replace(/\{\{(.*?)\}\}/g, (_, token) => {
          const trimmed = token.trim();
          return params[trimmed] !== undefined ? params[trimmed] : '';
        });
      }
      return value;
    }

    let currentOrdersCache = [];

    function applyTranslations() {
      const lang = state.language === 'ar' ? 'ar' : 'en';
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      document.title = resolveTranslation(lang, 'meta.title');
      languageToggle.textContent = lang === 'ar' ? 'English' : 'عربي';

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const text = resolveTranslation(lang, key);
        if (typeof text === 'string') {
          el.textContent = text;
        }
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        const text = resolveTranslation(lang, key);
        if (typeof text === 'string') {
          el.setAttribute('placeholder', text);
        }
      });

      const statusText = state.hasKeys ? resolveTranslation(lang, 'api.connected') : resolveTranslation(lang, 'api.disconnected');
      apiKeysStatus.textContent = statusText;
      apiKeysStatus.className = `pill ${state.hasKeys ? 'success' : 'danger'}`;

      renderTables();
      renderOrders(currentOrdersCache);
    }

    function setStatus(message, type = 'info') {
      if (!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.className = `status ${message ? type : ''}`.trim();
      clearTimeout(state.statusTimer);
      if (message) {
        state.statusTimer = setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'status';
        }, 6000);
      }
    }

    function setToken(token) {
      state.token = token || '';
      if (state.token) {
        localStorage.setItem('mybot_token', state.token);
      } else {
        localStorage.removeItem('mybot_token');
      }
    }

    function setLanguage(lang) {
      state.language = lang === 'ar' ? 'ar' : 'en';
      localStorage.setItem('mybot_language', state.language);
      applyTranslations();
    }

    function showLanding() {
      landing.classList.remove('hidden');
      authSection.classList.remove('hidden');
      dashboard.classList.add('hidden');
    }

    function showDashboard() {
      landing.classList.add('hidden');
      authSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
    }

    async function api(url, options = {}) {
      const headers = options.headers ? { ...options.headers } : {};
      if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
      const opts = {
        ...options,
        headers,
      };
      if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(options.body);
      }
      const res = await fetch(url, opts);
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.error || res.statusText || 'Request failed');
      }
      return res.json().catch(() => ({}));
    }

    function extractRules(payload) {
      const list = [];
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.rules)) return payload.rules;
      if (payload && Array.isArray(payload.data)) return payload.data;
      return list;
    }

    function renderTables() {
      renderManualRules();
      renderAiRules();
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function formatNumber(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '-';
      const abs = Math.abs(num);
      const opts = { maximumFractionDigits: 8 };
      if (abs >= 1000) opts.maximumFractionDigits = 2;
      else if (abs >= 100) opts.maximumFractionDigits = 2;
      else if (abs >= 1) opts.maximumFractionDigits = 4;
      return num.toLocaleString(undefined, opts);
    }

    function formatCurrency(v) {
      const num = Number(v);
      if (!Number.isFinite(num)) return '-';
      return `${formatNumber(num)} USDT`;
    }

    function formatPercent(v) {
      const num = Number(v);
      if (!Number.isFinite(num)) return '-';
      return `${num.toFixed(2)}%`;
    }

    function formatDate(ms) {
      if (!ms) return '-';
      const d = new Date(Number(ms));
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleString(state.language === 'ar' ? 'ar-EG' : undefined);
    }

    function renderManualRules() {
      const manualRules = state.rules.filter(r => (r.type || '').toLowerCase() === 'manual');
      manualCountEl.textContent = manualRules.length;
      manualTableBody.innerHTML = '';
      if (!manualRules.length) {
        const tr = document.createElement('tr');
        tr.className = 'empty-row';
        tr.innerHTML = `<td colspan="5">${escapeHtml(translate('manualRules.empty'))}</td>`;
        manualTableBody.appendChild(tr);
        return;
      }
      for (const rule of manualRules) {
        const tr = document.createElement('tr');
        if (!rule.enabled) tr.classList.add('is-paused');
        tr.dataset.id = rule.id;
        const errorMessage = rule.lastError ? translate('status.ruleError', { message: rule.lastError }) : '';
        const errorTitle = rule.lastErrorAt ? ` title="${escapeHtml(formatDate(rule.lastErrorAt))}"` : '';
        const errorNote = rule.lastError ? `<div class="rule-alert"${errorTitle}>${escapeHtml(errorMessage)}</div>` : '';
        tr.innerHTML = `
          <td data-label="${escapeHtml(translate('manual.table.rule'))}">
            <div class="symbol">${escapeHtml(rule.symbol)}</div>
            ${errorNote}
          </td>
          <td data-label="${escapeHtml(translate('manual.table.targets'))}">
            <div>${escapeHtml(translate('manualRules.buyOnDipLabel'))} <strong>${formatPercent(rule.dipPct)}</strong></div>
            <div class="muted small">${escapeHtml(translate('manualRules.takeProfitLabel'))} ${formatPercent(rule.tpPct)}</div>
          </td>
          <td data-label="${escapeHtml(translate('manual.table.budget'))}">${formatCurrency(rule.budgetUSDT)}</td>
          <td data-label="${escapeHtml(translate('manual.table.status'))}">
            <label class="switch">
              <input type="checkbox" data-action="toggle" data-id="${rule.id}" ${rule.enabled ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </td>
          <td data-label="${escapeHtml(translate('manual.table.actions'))}">
            <button class="btn-text danger" data-action="delete" data-id="${rule.id}">${escapeHtml(translate('common.delete'))}</button>
          </td>
        `;
        manualTableBody.appendChild(tr);
      }
    }

    function renderAiRules() {
      const aiRules = state.rules.filter(r => (r.type || '').toLowerCase() === 'ai');
      aiCountEl.textContent = aiRules.length;
      aiTableBody.innerHTML = '';
      if (!aiRules.length) {
        const tr = document.createElement('tr');
        tr.className = 'empty-row';
        tr.innerHTML = `<td colspan="6">${escapeHtml(translate('aiRules.empty'))}</td>`;
        aiTableBody.appendChild(tr);
        return;
      }
      for (const rule of aiRules) {
        const tr = document.createElement('tr');
        if (!rule.enabled) tr.classList.add('is-paused');
        tr.dataset.id = rule.id;
        const errorMessage = rule.lastError ? translate('status.ruleError', { message: rule.lastError }) : '';
        const errorTitle = rule.lastErrorAt ? ` title="${escapeHtml(formatDate(rule.lastErrorAt))}"` : '';
        const errorNote = rule.lastError ? `<div class="rule-alert"${errorTitle}>${escapeHtml(errorMessage)}</div>` : '';
        tr.innerHTML = `
          <td data-label="${escapeHtml(translate('ai.table.rule'))}">
            <div class="symbol">${escapeHtml(rule.symbol)}</div>
            ${errorNote}
            <details class="ai-details">
              <summary>${escapeHtml(translate('aiRules.summaryToggle'))}</summary>
              <div class="ai-summary">${escapeHtml(rule.aiSummary || '')}</div>
            </details>
          </td>
          <td data-label="${escapeHtml(translate('ai.table.entry'))}">${formatNumber(rule.entryPrice)}</td>
          <td data-label="${escapeHtml(translate('ai.table.exit'))}">${formatNumber(rule.exitPrice)}</td>
          <td data-label="${escapeHtml(translate('ai.table.budget'))}">${formatCurrency(rule.budgetUSDT)}</td>
          <td data-label="${escapeHtml(translate('ai.table.status'))}">
            <label class="switch">
              <input type="checkbox" data-action="toggle" data-id="${rule.id}" ${rule.enabled ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </td>
          <td data-label="${escapeHtml(translate('ai.table.actions'))}">
            <button class="btn-text danger" data-action="delete" data-id="${rule.id}">${escapeHtml(translate('common.delete'))}</button>
          </td>
        `;
        aiTableBody.appendChild(tr);
      }
    }

    function renderOrders(rows) {
      currentOrdersCache = Array.isArray(rows) ? rows : [];
      ordersTableBody.innerHTML = '';
      if (!currentOrdersCache.length) {
        const tr = document.createElement('tr');
        tr.className = 'empty-row';
        tr.innerHTML = `<td colspan="7">${escapeHtml(translate('orders.empty'))}</td>`;
        ordersTableBody.appendChild(tr);
        return;
      }
      for (const item of currentOrdersCache) {
        if (item.error) {
          const tr = document.createElement('tr');
          tr.className = 'empty-row';
          tr.innerHTML = `<td colspan="7">${escapeHtml(item.symbol)}: ${escapeHtml(item.error)}</td>`;
          ordersTableBody.appendChild(tr);
          continue;
        }
        for (const order of item.orders || []) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="${escapeHtml(translate('orders.table.symbol'))}">${escapeHtml(order.symbol)}</td>
            <td data-label="${escapeHtml(translate('orders.table.side'))}"><span class="pill ${order.side === 'BUY' ? 'success' : 'danger'}">${order.side}</span></td>
            <td data-label="${escapeHtml(translate('orders.table.price'))}">${formatNumber(order.price)}</td>
            <td data-label="${escapeHtml(translate('orders.table.qty'))}">${formatNumber(order.origQty)}</td>
            <td data-label="${escapeHtml(translate('orders.table.type'))}">${escapeHtml(order.type)}</td>
            <td data-label="${escapeHtml(translate('orders.table.status'))}">${escapeHtml(order.status)}</td>
            <td data-label="${escapeHtml(translate('orders.table.updated'))}">${formatDate(order.updateTime || order.time)}</td>
          `;
          ordersTableBody.appendChild(tr);
        }
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const payload = {
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value
      };
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Login failed');
        setToken(data.token);
        state.user = data.user;
        await bootstrapDashboard();
        setStatus(translate('status.loginSuccess'), 'success');
      } catch (err) {
        console.error('login error', err);
        setStatus(err.message, 'error');
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      const payload = {
        name: document.getElementById('registerName').value,
        email: document.getElementById('registerEmail').value,
        password: document.getElementById('registerPassword').value
      };
      try {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Registration failed');
        setToken(data.token);
        state.user = data.user;
        await bootstrapDashboard();
        setStatus(translate('status.registerSuccess'), 'success');
      } catch (err) {
        console.error('register error', err);
        setStatus(err.message, 'error');
      }
    }

    async function bootstrapDashboard() {
      try {
        await fetchCurrentUser();
        showDashboard();
        await loadRules();
        await loadOrders();
        await refreshApiKeysStatus();
        if (state.ordersTimer) clearInterval(state.ordersTimer);
        state.ordersTimer = setInterval(() => loadOrders(true), 8000);
      } catch (err) {
        console.error('bootstrap error', err);
        setStatus(err.message, 'error');
      }
    }

    async function fetchCurrentUser() {
      const data = await api('/api/auth/me');
      state.user = data.user;
      state.hasKeys = Boolean(data.hasApiKeys);
      const greeting = state.user?.name ? `${translate('dashboard.welcome')} ${state.user.name}` : translate('dashboard.welcome');
      welcomeName.textContent = greeting;
      updateApiKeysStatus();
    }

    async function loadRules() {
      const data = await api('/api/rules');
      state.rules = extractRules(data);
      renderTables();
    }

    async function persistAll(rules, message) {
      const response = await api('/api/rules', { method: 'POST', body: rules });
      state.rules = extractRules(response);
      renderTables();
      if (message) setStatus(message.text, message.type || 'success');
    }

    async function loadOrders(silent) {
      if (state.isOrdersLoading) return;
      state.isOrdersLoading = true;
      try {
        const data = await api('/api/orders');
        renderOrders(Array.isArray(data) ? data : []);
        if (!silent) setStatus(translate('status.ordersRefreshed'), 'info');
      } catch (err) {
        renderOrders([]);
        setStatus(err.message, 'error');
      } finally {
        state.isOrdersLoading = false;
      }
    }

    async function refreshApiKeysStatus() {
      try {
        const data = await api('/api/users/api-keys');
        state.hasKeys = Boolean(data.hasKeys);
      } catch (err) {
        state.hasKeys = false;
        console.error('api key status error', err);
      }
      updateApiKeysStatus();
    }

    function updateApiKeysStatus() {
      if (!apiKeysStatus) return;
      const label = state.hasKeys ? 'api.connected' : 'api.disconnected';
      apiKeysStatus.textContent = translate(label);
      apiKeysStatus.className = `pill ${state.hasKeys ? 'success' : 'danger'}`;
    }

    async function submitApiKeys(event) {
      event.preventDefault();
      const payload = {
        apiKey: document.getElementById('apiKey').value,
        apiSecret: document.getElementById('apiSecret').value
      };
      try {
        await api('/api/users/api-keys', { method: 'POST', body: payload });
        state.hasKeys = true;
        updateApiKeysStatus();
        setStatus(translate('status.keysSaved'), 'success');
      } catch (err) {
        console.error('api key save error', err);
        setStatus(err.message, 'error');
      }
    }

    async function removeApiKeys() {
      try {
        await api('/api/users/api-keys', { method: 'DELETE' });
        state.hasKeys = false;
        updateApiKeysStatus();
        setStatus(translate('status.keysRemoved'), 'info');
      } catch (err) {
        console.error('remove keys error', err);
        setStatus(err.message, 'error');
      }
    }

    async function addManualRule(event) {
      event.preventDefault();
      const rule = {
        id: generateId(),
        type: 'manual',
        symbol: document.getElementById('symbol').value.trim().toUpperCase(),
        dipPct: Number(document.getElementById('dip').value),
        tpPct: Number(document.getElementById('tp').value),
        budgetUSDT: Number(document.getElementById('budget').value),
        enabled: true,
        createdAt: Date.now()
      };
      const next = [...state.rules, rule];
      try {
        await persistAll(next, { text: translate('status.manualAdded'), type: 'success' });
        manualForm.reset();
      } catch (err) {
        setStatus(err.message, 'error');
      }
    }

    async function syncRules() {
      try {
        const response = await api('/api/rules/sync', { method: 'POST' });
        state.rules = extractRules(response);
        renderTables();
        setStatus(translate('status.manualSynced'), 'info');
      } catch (err) {
        setStatus(err.message, 'error');
      }
    }

    async function toggleRule(id, enabled) {
      const next = state.rules.map(r => r.id === id ? { ...r, enabled } : r);
      try {
        await persistAll(next, { text: translate(enabled ? 'status.ruleActivated' : 'status.rulePaused'), type: 'info' });
      } catch (err) {
        setStatus(err.message, 'error');
      }
    }

    async function deleteRule(id) {
      if (!id) return;
      if (!confirm(translate('common.confirmDelete'))) return;
      try {
        const data = await api(`/api/rules/${id}`, { method: 'DELETE' });
        state.rules = extractRules(data);
        renderTables();
        setStatus(translate('status.ruleDeleted'), 'info');
      } catch (err) {
        setStatus(err.message, 'error');
      }
    }

    async function generateAiRule(event) {
      event.preventDefault();
      if (aiGenerateBtn.dataset.loading === 'true') return;
      const budget = Number(document.getElementById('aiBudget').value);
      if (!(budget > 0)) {
        setStatus(translate('status.aiBudgetInvalid'), 'error');
        return;
      }
      aiGenerateBtn.dataset.loading = 'true';
      aiGenerateBtn.disabled = true;
      try {
        const data = await api('/api/ai-role', {
          method: 'POST',
          body: { budgetUSDT: budget, locale: state.language }
        });
        await loadRules();
        if (data && data.rule && data.rule.aiModel) {
          const modelInput = document.getElementById('aiModel');
          if (modelInput) modelInput.value = data.rule.aiModel;
        }
        setStatus(translate('status.aiGenerated'), 'success');
        await loadOrders(true);
      } catch (err) {
        console.error('ai error', err);
        setStatus(err.message, 'error');
      } finally {
        aiGenerateBtn.disabled = false;
        delete aiGenerateBtn.dataset.loading;
      }
    }

    function handleLogout() {
      setToken('');
      state.user = null;
      state.rules = [];
      state.hasKeys = false;
      if (state.ordersTimer) clearInterval(state.ordersTimer);
      renderTables();
      renderOrders([]);
      showLanding();
    }

    function initAuthTabs() {
      authTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          authTabs.forEach(btn => btn.classList.toggle('is-active', btn === tab));
          const target = tab.getAttribute('data-auth-tab');
          document.querySelectorAll('[data-auth-panel]').forEach(panel => {
            panel.classList.toggle('hidden', panel.getAttribute('data-auth-panel') !== target);
          });
        });
      });
    }

    document.body.addEventListener('change', event => {
      const target = event.target;
      if (target && target.dataset && target.dataset.action === 'toggle') {
        toggleRule(target.dataset.id, target.checked);
      }
    });

    document.body.addEventListener('click', event => {
      const btn = event.target.closest('[data-action="delete"]');
      if (btn) {
        deleteRule(btn.dataset.id);
      }
    });

    document.querySelectorAll('[data-scroll-to-auth]').forEach(btn => {
      btn.addEventListener('click', event => {
        event.preventDefault();
        window.scrollTo({ top: authSection.offsetTop - 40, behavior: 'smooth' });
      });
    });

    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);
    logoutBtn.addEventListener('click', handleLogout);
    apiKeysForm.addEventListener('submit', submitApiKeys);
    removeKeysBtn.addEventListener('click', removeApiKeys);
    manualForm.addEventListener('submit', addManualRule);
    syncRulesBtn.addEventListener('click', syncRules);
    aiForm.addEventListener('submit', generateAiRule);
    refreshOrdersBtn.addEventListener('click', () => loadOrders());
    languageToggle.addEventListener('click', () => {
      setLanguage(state.language === 'ar' ? 'en' : 'ar');
    });

    initAuthTabs();

    async function init() {
      applyTranslations();
      renderTables();
      renderOrders([]);
      if (state.token) {
        try {
          await bootstrapDashboard();
        } catch (err) {
          console.error('init error', err);
          setStatus(err.message, 'error');
          handleLogout();
        }
      }
    }

    init();
  })();
  </script>
</body>
</html>
